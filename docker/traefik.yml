---
- vars:
    service: "traefik"
    labels:
    - key: "traefik.enable"
      value: "true"

  hosts: all
  become: yes
  vars_files: 
    - ../vars/vars.yml
    - ../vars/vault.yml

  tasks:
    - name: Ensures traefik dir exists
      file:
        path: "{{ traefik }}"
        state: directory

    - name: Ensures acme.json file exists
      file:
        path: "{{ traefik }}/acme.json"
        state: touch
        mode: 0600

    - name: Adding traefik.yml file
      template:
        src: ../local/traefik/traefik.yml.j2
        dest: "{{ traefik }}/traefik.yml"
        mode: 0600

    - name: Generate basic auth password and username and output to variable
      shell: "echo $(htpasswd -nbB {{ traefik_user }} '{{ traefik_password }}') | sed -e s/\\$/\\$\\$/g"
      register: shell_output

    - name: Update labels with generated basic auth
      ansible.builtin.set_fact:
        labels: "{{ labels + [{ 'key': 'traefik.http.middlewares.auth.basicauth.users', 'value': (shell_output.stdout) }] }}"

    - name: Starting the reverse proxy.
      docker_container:
        name: "{{ service }}"
        image: traefik:latest
        restart_policy: always
        state: started
        recreate: true
        ports:
        - "80:80"
        - "443:443"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - "{{ traefik }}/acme.json:/letsencrypt/acme.json"
          - "{{ traefik }}{{ traefik_file }}:/etc/traefik/traefik.yml"
        labels: "{{ labels | items2dict}}"
