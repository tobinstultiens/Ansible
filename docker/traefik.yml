---
- vars:
    service: "traefik"
    labels:
    - key: "traefik.enable"
      value: "true"
    - key: "traefik.http.middlewares.auth.basicauth.users"
      value: "{{ traefik_user }}:{{ traefik_password | password_hash('blowfish','1234567890123456789012') }}"

  hosts: all
  become: yes
  vars_files: 
    - ../vars/vars.yml
    - ../vars/vault.yml

  tasks:
    - name: Ensures traefik dir exists
      file:
        path: "{{ traefik }}"
        state: directory

    - name: Ensures acme.json file exists
      file:
        path: "{{ traefik }}/acme.json"
        state: touch
        mode: 0600

    - name: Adding traefik.yml file
      template:
        src: ../local/traefik/traefik.yml.j2
        dest: "{{ traefik }}/traefik.yml"
        mode: 0600
    
    - name: Starting the reverse proxy.
      docker_container:
        name: "{{ service }}"
        image: traefik:latest
        restart_policy: always
        state: started
        recreate: true
        ports:
        - "80:80"
        - "443:443"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - "{{ traefik }}/acme.json:/letsencrypt/acme.json"
          - "{{ traefik }}{{ traefik_file }}:/etc/traefik/traefik.yml"
        labels: "{{ labels | items2dict}}"
